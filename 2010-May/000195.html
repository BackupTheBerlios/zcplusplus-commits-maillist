<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Zcplusplus-commits] r428 - trunk
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/zcplusplus-commits/2010-May/index.html" >
   <LINK REL="made" HREF="mailto:zcplusplus-commits%40lists.berlios.de?Subject=Re%3A%20%5BZcplusplus-commits%5D%20r428%20-%20trunk&In-Reply-To=%3C201005140449.o4E4nZAP010508%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000194.html">
   <LINK REL="Next"  HREF="000196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Zcplusplus-commits] r428 - trunk</H1>
    <B>zaimoni at mail.berlios.de</B> 
    <A HREF="mailto:zcplusplus-commits%40lists.berlios.de?Subject=Re%3A%20%5BZcplusplus-commits%5D%20r428%20-%20trunk&In-Reply-To=%3C201005140449.o4E4nZAP010508%40sheep.berlios.de%3E"
       TITLE="[Zcplusplus-commits] r428 - trunk">zaimoni at mail.berlios.de
       </A><BR>
    <I>Fri May 14 06:49:35 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="000194.html">[Zcplusplus-commits] r427 - trunk/Zaimoni.STL
</A></li>
        <LI>Next message: <A HREF="000196.html">[Zcplusplus-commits] r429 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#195">[ date ]</a>
              <a href="thread.html#195">[ thread ]</a>
              <a href="subject.html#195">[ subject ]</a>
              <a href="author.html#195">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: zaimoni
Date: 2010-05-14 06:49:26 +0200 (Fri, 14 May 2010)
New Revision: 428

Modified:
   trunk/CPreproc.cpp
   trunk/CPreproc_autogen.cpp
   trunk/CPreproc_autogen_pp.cpp
   trunk/CPreproc_pp.cpp
   trunk/load_src.cpp
Log:
switch to throwing insertNSlotsAt from return-value InsertNSlotsAt where convenient

Modified: trunk/CPreproc.cpp
===================================================================
--- trunk/CPreproc.cpp	2010-05-13 05:12:38 UTC (rev 427)
+++ trunk/CPreproc.cpp	2010-05-14 04:49:26 UTC (rev 428)
@@ -1,5 +1,5 @@
 // CPreproc.cpp
-// (C)2009 Kenneth Boyd, license: MIT.txt
+// (C)2009,2010 Kenneth Boyd, license: MIT.txt
 
 #/*cut-cpp*/
 #include &quot;CPreproc.hpp&quot;
@@ -1181,10 +1181,9 @@
 								continue;
 								};
 							const size_t object_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(object_macro_index);
-							if (   !macros_object.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion_pre_eval.InsertNSlotsAt(1,object_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_object.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion_pre_eval.insertNSlotsAt(1,object_macro_insertion_index);
 							macros_object[object_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 							strncpy(macros_object[object_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
 							ZAIMONI_NULL_TERMINATE(macros_object[object_macro_insertion_index][first_token_len]);
@@ -1231,10 +1230,9 @@
 
 							// DO NOT check for context free errors here; could legitimately want to deep-stringize every invocation of the macro
 							const size_t object_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(object_macro_index);
-							if (   !macros_object.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion_pre_eval.InsertNSlotsAt(1,object_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_object.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion_pre_eval.insertNSlotsAt(1,object_macro_insertion_index);
 							macros_object[object_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 							strncpy(macros_object[object_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1308,11 +1306,10 @@
 									continue;
 									}
 								const size_t function_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(function_macro_index);
-								if (   !macros_function.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_arglist.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_expansion.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_expansion_pre_eval.InsertNSlotsAt(1,function_macro_insertion_index))
-									throw std::bad_alloc();
+								macros_function.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_arglist.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_expansion.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_expansion_pre_eval.insertNSlotsAt(1,function_macro_insertion_index);
 								macros_function[function_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 								strncpy(macros_function[function_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1354,11 +1351,10 @@
 
 							// DO NOT check for context free errors here; could legitimately want to deep-stringize every invocation of the macro
 							const size_t function_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(function_macro_index);
-							if (   !macros_function.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_arglist.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_expansion.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_expansion_pre_eval.InsertNSlotsAt(1,function_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_function.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_arglist.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_expansion.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_expansion_pre_eval.insertNSlotsAt(1,function_macro_insertion_index);
 							macros_function[function_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 							strncpy(macros_function[function_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1981,9 +1977,8 @@
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(have_file_index);
 					const errr cache_index = binary_find(main_index_name,strlen(main_index_name),include_file_cache);
 					const size_t include_file_cache_target = BINARY_SEARCH_DECODE_INSERTION_POINT(cache_index);
-					if (   !include_file_index.InsertNSlotsAt(1,include_file_index_target)
-						|| !include_file_cache.InsertNSlotsAt(1,include_file_cache_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
+					include_file_cache.insertNSlotsAt(1,include_file_cache_target);
 					include_file_cache[include_file_cache_target].second = new autovalarray_ptr&lt;Token&lt;char&gt;* &gt;(IncludeTokenList);
 					include_file_cache[include_file_cache_target].first = main_index_name;
 					include_file_index[include_file_index_target].first = main_index_name;
@@ -2055,9 +2050,8 @@
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
 					tmp = binary_find(main_index_name,strlen(main_index_name),include_file_cache);
 					const size_t include_file_cache_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
-					if (   !include_file_index.InsertNSlotsAt(1,include_file_index_target)
-						|| !include_file_cache.InsertNSlotsAt(1,include_file_cache_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
+					include_file_cache.insertNSlotsAt(1,include_file_cache_target);
 					include_file_cache[include_file_cache_target].second = new autovalarray_ptr&lt;Token&lt;char&gt;* &gt;(IncludeTokenList);
 					include_file_cache[include_file_cache_target].first = main_index_name;
 					include_file_index[include_file_index_target].first = look_for;
@@ -2069,8 +2063,7 @@
 					// set up include_file_index
 					tmp = binary_find(look_for,filename_len,include_file_index);
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
-					if (!include_file_index.InsertNSlotsAt(1,include_file_index_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
 					include_file_index[include_file_index_target].first = look_for;
 					include_file_index[include_file_index_target].second = NULL;
 					include_file_index[include_file_index_target].third = CPP_INCLUDE_NOT_FOUND;
@@ -2100,7 +2093,7 @@
 			if (!IncludeTokenList.empty())
 				{
 				size_t j = IncludeTokenList.size();
-				if (!TokenList.InsertNSlotsAt(j,include_where+1)) throw std::bad_alloc();
+				TokenList.insertNSlotsAt(j,include_where+1);
 				memmove(TokenList.c_array()+include_where+1,IncludeTokenList.data(),j*sizeof(Token&lt;char*&gt;*));
 #ifdef ZAIMONI_NULL_REALLY_IS_ZERO
 				memset(IncludeTokenList.c_array(),0,j*sizeof(Token&lt;char*&gt;*));
@@ -2320,7 +2313,7 @@
 	else{
 		size_t lb = 0;
 		autovalarray_ptr_throws&lt;Token&lt;char&gt;* &gt; TokenListAlt(ub+1);
-		if (!TokenList.InsertNSlotsAt(ub,i+1)) throw std::bad_alloc();
+		TokenList.insertNSlotsAt(ub,i+1);
 		{
 		const Token&lt;char&gt;&amp; tmp = *TokenList[i];
 		while(lb&lt;ub)
@@ -3541,7 +3534,7 @@
 			intradirective_preprocess(Test,0,macros_object,macros_object_expansion,macros_function,macros_function_arglist,macros_function_expansion,&amp;macro_stack);
 			}
 		else{
-			if (!used_macro_stack-&gt;InsertNSlotsAt(1,used_macro_stack-&gt;size())) throw std::bad_alloc();
+			used_macro_stack-&gt;insertNSlotsAt(1,used_macro_stack-&gt;size());
 			used_macro_stack-&gt;back() = _new_buffer_nonNULL_throws&lt;char&gt;(token_len);
 			memmove(used_macro_stack-&gt;back(),x.data()+critical_offset,token_len);
 			intradirective_preprocess(Test,0,macros_object,macros_object_expansion,macros_function,macros_function_arglist,macros_function_expansion,used_macro_stack);
@@ -3641,7 +3634,7 @@
 			dynamic_function_macro_prereplace_once(macros_object, macros_object_expansion, macros_function, macros_function_arglist, macros_function_expansion, &amp;macro_stack, formal_arguments, actual_arguments, Test);
 			}
 		else{
-			if (!used_macro_stack-&gt;InsertNSlotsAt(1,used_macro_stack-&gt;size())) throw std::bad_alloc();
+			used_macro_stack-&gt;insertNSlotsAt(1,used_macro_stack-&gt;size());
 			used_macro_stack-&gt;back() = _new_buffer_nonNULL_throws&lt;char&gt;(token_len);
 			memmove(used_macro_stack-&gt;back(),x.data()+critical_offset,token_len);
 

Modified: trunk/CPreproc_autogen.cpp
===================================================================
--- trunk/CPreproc_autogen.cpp	2010-05-13 05:12:38 UTC (rev 427)
+++ trunk/CPreproc_autogen.cpp	2010-05-14 04:49:26 UTC (rev 428)
@@ -279,6 +279,7 @@
 #define STDINT_CPP_LEAST_FAST_INJECT_LINE 61
 
 // inject preprocessor block of preexisting definitions
+//! \throw std::bad_alloc
 static void
 disallow_prior_definitions(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,size_t i,const char* const * identifiers,size_t identifiers_len)
 {
@@ -292,7 +293,7 @@
 #undef __bool_true_false_are_defined
 #endif
 */
-	if (!TokenList.InsertNSlotsAt(4*identifiers_len,i)) throw std::bad_alloc();
+	TokenList.insertNSlotsAt(4*identifiers_len,i);
 	while(0&lt;identifiers_len)
 		{
 		assert(*identifiers &amp;&amp; **identifiers);
@@ -300,48 +301,33 @@
 		tmp[i+3] = new zaimoni::Token&lt;char&gt;(&quot;#endif&quot;,0,sizeof(&quot;#endif&quot;)-1,0);
 
 		const size_t identifier_len = strlen(*identifiers);
-		char* tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len));
+		zaimoni::autovalarray_ptr_throws&lt;char&gt; tmp2(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len));
 		strcpy(tmp2,&quot;#ifdef &quot;);
 		strcpy(tmp2+sizeof(&quot;#ifdef &quot;)-1,*identifiers);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len),NULL);
+		tmp[i] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len),NULL);
 #endif
-		if (NULL==tmp[i])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
-		tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len));
+		tmp2.resize(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len));
 		strcpy(tmp2,&quot;#undef &quot;);
 		strcpy(tmp2+sizeof(&quot;#undef &quot;)-1,*identifiers);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i+2] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i+2] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i+2] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len),NULL);
+		tmp[i+2] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len),NULL);
 #endif
-		if (NULL==tmp[i+2])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
-		tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1));
+		tmp2.resize(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1));
 		strcpy(tmp2,&quot;#error Undefined Behavior: reserved identifier '&quot;);
 		strcpy(tmp2+sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1,*identifiers);
 		strcpy(tmp2+sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len,&quot;' defined as macro&quot;);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i+1] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i+1] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i+1] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1),NULL);
+		tmp[i+1] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1),NULL);
 #endif
-		if (NULL==tmp[i+1])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
 		i += 4;
 		--identifiers_len;
@@ -350,6 +336,7 @@
 }
 
 // inject preprocessor lockdown for a reserved identifier
+//! \throw std::bad_alloc
 static void
 lockdown_reserved_identifiers(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const size_t i,const char* const * identifiers,size_t identifiers_len)
 {
@@ -363,8 +350,9 @@
 		target_len += strlen(identifiers[j])+1;
 		}
 	while(identifiers_len&gt; ++j);
-	char* tmp = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(target_len));
-	char* tmp2 = tmp;
+	zaimoni::autovalarray_ptr_throws&lt;char&gt; tmp(ZAIMONI_LEN_WITH_NULL(target_len));
+	{
+	char* tmp2 = tmp.c_array();
 	strcpy(tmp2,&quot;#pragma ZCC lock&quot;);
 	tmp2 += sizeof(&quot;#pragma ZCC lock&quot;)-1;
 	while(0&lt;identifiers_len)
@@ -375,16 +363,12 @@
 		++identifiers;
 		--identifiers_len;
 		};
+	}
 #ifndef ZAIMONI_FORCE_ISO
-	zaimoni::Token&lt;char&gt;* relay = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp,NULL);
+	zaimoni::Token&lt;char&gt;* relay = new zaimoni::Token&lt;char&gt;(tmp,NULL);
 #else
-	zaimoni::Token&lt;char&gt;* relay = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp,ZAIMONI_LEN_WITH_NULL(target_len),NULL);
+	zaimoni::Token&lt;char&gt;* relay = new zaimoni::Token&lt;char&gt;(tmp,ZAIMONI_LEN_WITH_NULL(target_len),NULL);
 #endif
-	if (NULL==relay)
-		{
-		free(tmp);
-		throw std::bad_alloc();
-		};
 	if (!TokenList.InsertSlotAt(i,relay))
 		{
 		delete relay;
@@ -414,6 +398,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_limits_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -598,6 +583,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_stddef_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -682,6 +668,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_stdint_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -1189,7 +1176,7 @@
 	const unsigned short bitspan_types = type_bits[virtual_machine::std_int_long_long-1]-7;
 	assert(USHRT_MAX/13&gt;=bitspan_types);
 	i = 4*bitspan_types;
-	TmpTokenList.InsertNSlotsAt(i,inject_CPP_index);
+	TmpTokenList.insertNSlotsAt(i,inject_CPP_index);
 	tmp = TmpTokenList.c_array()+inject_CPP_index;
 	do	{
 		const int target_bits = --i/4+8;
@@ -1232,7 +1219,7 @@
 	zaimoni::autovalarray_ptr_throws&lt;char&gt; define_buf(sizeof(&quot;#define UINT_LEAST_MAX&quot;)+2+VM_MAX_BIT_PLATFORM/3+5);
 	strcpy(define_buf,&quot;#define &quot;);
 	i = 13*bitspan_types;
-	TmpTokenList.InsertNSlotsAt(i,inject_C_index);
+	TmpTokenList.insertNSlotsAt(i,inject_C_index);
 	tmp = TmpTokenList.c_array()+inject_C_index;
 	do	{
 		const int target_bits = --i/13+8;

Modified: trunk/CPreproc_autogen_pp.cpp
===================================================================
--- trunk/CPreproc_autogen_pp.cpp	2010-05-13 05:12:38 UTC (rev 427)
+++ trunk/CPreproc_autogen_pp.cpp	2010-05-14 04:49:26 UTC (rev 428)
@@ -276,6 +276,7 @@
 #define STDINT_CPP_LEAST_FAST_INJECT_LINE 61
 
 // inject preprocessor block of preexisting definitions
+//! \throw std::bad_alloc
 static void
 disallow_prior_definitions(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,size_t i,const char* const * identifiers,size_t identifiers_len)
 {
@@ -289,7 +290,7 @@
 #undef __bool_true_false_are_defined
 #endif
 */
-	if (!TokenList.InsertNSlotsAt(4*identifiers_len,i)) throw std::bad_alloc();
+	TokenList.insertNSlotsAt(4*identifiers_len,i);
 	while(0&lt;identifiers_len)
 		{
 		assert(*identifiers &amp;&amp; **identifiers);
@@ -297,48 +298,33 @@
 		tmp[i+3] = new zaimoni::Token&lt;char&gt;(&quot;#endif&quot;,0,sizeof(&quot;#endif&quot;)-1,0);
 
 		const size_t identifier_len = strlen(*identifiers);
-		char* tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len));
+		zaimoni::autovalarray_ptr_throws&lt;char&gt; tmp2(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len));
 		strcpy(tmp2,&quot;#ifdef &quot;);
 		strcpy(tmp2+sizeof(&quot;#ifdef &quot;)-1,*identifiers);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len),NULL);
+		tmp[i] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#ifdef &quot;)-1+identifier_len),NULL);
 #endif
-		if (NULL==tmp[i])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
-		tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len));
+		tmp2.resize(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len));
 		strcpy(tmp2,&quot;#undef &quot;);
 		strcpy(tmp2+sizeof(&quot;#undef &quot;)-1,*identifiers);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i+2] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i+2] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i+2] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len),NULL);
+		tmp[i+2] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#undef &quot;)-1+identifier_len),NULL);
 #endif
-		if (NULL==tmp[i+2])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
-		tmp2 = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1));
+		tmp2.resize(ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1));
 		strcpy(tmp2,&quot;#error Undefined Behavior: reserved identifier '&quot;);
 		strcpy(tmp2+sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1,*identifiers);
 		strcpy(tmp2+sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len,&quot;' defined as macro&quot;);
 #ifndef ZAIMONI_FORCE_ISO
-		tmp[i+1] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,NULL);
+		tmp[i+1] = new zaimoni::Token&lt;char&gt;(tmp2,NULL);
 #else
-		tmp[i+1] = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1),NULL);
+		tmp[i+1] = new zaimoni::Token&lt;char&gt;(tmp2,ZAIMONI_LEN_WITH_NULL(sizeof(&quot;#error Undefined Behavior: reserved identifier '&quot;)-1+identifier_len+sizeof(&quot;' defined as macro&quot;)-1),NULL);
 #endif
-		if (NULL==tmp[i+1])
-			{
-			free(tmp2);
-			throw std::bad_alloc();
-			}
 
 		i += 4;
 		--identifiers_len;
@@ -347,6 +333,7 @@
 }
 
 // inject preprocessor lockdown for a reserved identifier
+//! \throw std::bad_alloc
 static void
 lockdown_reserved_identifiers(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const size_t i,const char* const * identifiers,size_t identifiers_len)
 {
@@ -360,8 +347,9 @@
 		target_len += strlen(identifiers[j])+1;
 		}
 	while(identifiers_len&gt; ++j);
-	char* tmp = zaimoni::_new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(target_len));
-	char* tmp2 = tmp;
+	zaimoni::autovalarray_ptr_throws&lt;char&gt; tmp(ZAIMONI_LEN_WITH_NULL(target_len));
+	{
+	char* tmp2 = tmp.c_array();
 	strcpy(tmp2,&quot;#pragma ZCC lock&quot;);
 	tmp2 += sizeof(&quot;#pragma ZCC lock&quot;)-1;
 	while(0&lt;identifiers_len)
@@ -372,16 +360,12 @@
 		++identifiers;
 		--identifiers_len;
 		};
+	}
 #ifndef ZAIMONI_FORCE_ISO
-	zaimoni::Token&lt;char&gt;* relay = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp,NULL);
+	zaimoni::Token&lt;char&gt;* relay = new zaimoni::Token&lt;char&gt;(tmp,NULL);
 #else
-	zaimoni::Token&lt;char&gt;* relay = new(std::nothrow) zaimoni::Token&lt;char&gt;(tmp,ZAIMONI_LEN_WITH_NULL(target_len),NULL);
+	zaimoni::Token&lt;char&gt;* relay = new zaimoni::Token&lt;char&gt;(tmp,ZAIMONI_LEN_WITH_NULL(target_len),NULL);
 #endif
-	if (NULL==relay)
-		{
-		free(tmp);
-		throw std::bad_alloc();
-		};
 	if (!TokenList.InsertSlotAt(i,relay))
 		{
 		delete relay;
@@ -411,6 +395,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_limits_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -595,6 +580,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_stddef_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -679,6 +665,7 @@
  * \param TokenList : where to improvise to
  * \param header_name : what header we were requesting.
  */
+//! \throw std::bad_alloc
 void
 CPreprocessor::create_stdint_header(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList,const char* const header_name) const
 {
@@ -1186,7 +1173,7 @@
 	const unsigned short bitspan_types = type_bits[virtual_machine::std_int_long_long-1]-7;
 	assert(USHRT_MAX/13&gt;=bitspan_types);
 	i = 4*bitspan_types;
-	TmpTokenList.InsertNSlotsAt(i,inject_CPP_index);
+	TmpTokenList.insertNSlotsAt(i,inject_CPP_index);
 	tmp = TmpTokenList.c_array()+inject_CPP_index;
 	do	{
 		const int target_bits = --i/4+8;
@@ -1229,7 +1216,7 @@
 	zaimoni::autovalarray_ptr_throws&lt;char&gt; define_buf(sizeof(&quot;#define UINT_LEAST_MAX&quot;)+2+VM_MAX_BIT_PLATFORM/3+5);
 	strcpy(define_buf,&quot;#define &quot;);
 	i = 13*bitspan_types;
-	TmpTokenList.InsertNSlotsAt(i,inject_C_index);
+	TmpTokenList.insertNSlotsAt(i,inject_C_index);
 	tmp = TmpTokenList.c_array()+inject_C_index;
 	do	{
 		const int target_bits = --i/13+8;

Modified: trunk/CPreproc_pp.cpp
===================================================================
--- trunk/CPreproc_pp.cpp	2010-05-13 05:12:38 UTC (rev 427)
+++ trunk/CPreproc_pp.cpp	2010-05-14 04:49:26 UTC (rev 428)
@@ -1,5 +1,5 @@
 // CPreproc_pp.cpp
-// (C)2009 Kenneth Boyd, license: MIT.txt
+// (C)2009,2010 Kenneth Boyd, license: MIT.txt
 
 #include &quot;CPreproc_pp.hpp&quot;
 
@@ -1175,10 +1175,9 @@
 								continue;
 								};
 							const size_t object_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(object_macro_index);
-							if (   !macros_object.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion_pre_eval.InsertNSlotsAt(1,object_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_object.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion_pre_eval.insertNSlotsAt(1,object_macro_insertion_index);
 							macros_object[object_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 							strncpy(macros_object[object_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
 							ZAIMONI_NULL_TERMINATE(macros_object[object_macro_insertion_index][first_token_len]);
@@ -1225,10 +1224,9 @@
 
 							// DO NOT check for context free errors here; could legitimately want to deep-stringize every invocation of the macro
 							const size_t object_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(object_macro_index);
-							if (   !macros_object.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion.InsertNSlotsAt(1,object_macro_insertion_index)
-								|| !macros_object_expansion_pre_eval.InsertNSlotsAt(1,object_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_object.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion.insertNSlotsAt(1,object_macro_insertion_index);
+							macros_object_expansion_pre_eval.insertNSlotsAt(1,object_macro_insertion_index);
 							macros_object[object_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 							strncpy(macros_object[object_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1302,11 +1300,10 @@
 									continue;
 									}
 								const size_t function_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(function_macro_index);
-								if (   !macros_function.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_arglist.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_expansion.InsertNSlotsAt(1,function_macro_insertion_index)
-									|| !macros_function_expansion_pre_eval.InsertNSlotsAt(1,function_macro_insertion_index))
-									throw std::bad_alloc();
+								macros_function.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_arglist.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_expansion.insertNSlotsAt(1,function_macro_insertion_index);
+								macros_function_expansion_pre_eval.insertNSlotsAt(1,function_macro_insertion_index);
 								macros_function[function_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 								strncpy(macros_function[function_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1348,11 +1345,10 @@
 
 							// DO NOT check for context free errors here; could legitimately want to deep-stringize every invocation of the macro
 							const size_t function_macro_insertion_index = BINARY_SEARCH_DECODE_INSERTION_POINT(function_macro_index);
-							if (   !macros_function.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_arglist.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_expansion.InsertNSlotsAt(1,function_macro_insertion_index)
-								|| !macros_function_expansion_pre_eval.InsertNSlotsAt(1,function_macro_insertion_index))
-								throw std::bad_alloc();
+							macros_function.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_arglist.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_expansion.insertNSlotsAt(1,function_macro_insertion_index);
+							macros_function_expansion_pre_eval.insertNSlotsAt(1,function_macro_insertion_index);
 							macros_function[function_macro_insertion_index] = _new_buffer_nonNULL_throws&lt;char&gt;(ZAIMONI_LEN_WITH_NULL(first_token_len));
 
 							strncpy(macros_function[function_macro_insertion_index],TokenList[i]-&gt;data()+critical_offset,first_token_len);
@@ -1975,9 +1971,8 @@
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(have_file_index);
 					const errr cache_index = binary_find(main_index_name,strlen(main_index_name),include_file_cache);
 					const size_t include_file_cache_target = BINARY_SEARCH_DECODE_INSERTION_POINT(cache_index);
-					if (   !include_file_index.InsertNSlotsAt(1,include_file_index_target)
-						|| !include_file_cache.InsertNSlotsAt(1,include_file_cache_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
+					include_file_cache.insertNSlotsAt(1,include_file_cache_target);
 					include_file_cache[include_file_cache_target].second = new autovalarray_ptr&lt;Token&lt;char&gt;* &gt;(IncludeTokenList);
 					include_file_cache[include_file_cache_target].first = main_index_name;
 					include_file_index[include_file_index_target].first = main_index_name;
@@ -2049,9 +2044,8 @@
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
 					tmp = binary_find(main_index_name,strlen(main_index_name),include_file_cache);
 					const size_t include_file_cache_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
-					if (   !include_file_index.InsertNSlotsAt(1,include_file_index_target)
-						|| !include_file_cache.InsertNSlotsAt(1,include_file_cache_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
+					include_file_cache.insertNSlotsAt(1,include_file_cache_target);
 					include_file_cache[include_file_cache_target].second = new autovalarray_ptr&lt;Token&lt;char&gt;* &gt;(IncludeTokenList);
 					include_file_cache[include_file_cache_target].first = main_index_name;
 					include_file_index[include_file_index_target].first = look_for;
@@ -2063,8 +2057,7 @@
 					// set up include_file_index
 					tmp = binary_find(look_for,filename_len,include_file_index);
 					const size_t include_file_index_target = BINARY_SEARCH_DECODE_INSERTION_POINT(tmp);
-					if (!include_file_index.InsertNSlotsAt(1,include_file_index_target))
-						throw std::bad_alloc();
+					include_file_index.insertNSlotsAt(1,include_file_index_target);
 					include_file_index[include_file_index_target].first = look_for;
 					include_file_index[include_file_index_target].second = NULL;
 					include_file_index[include_file_index_target].third = CPP_INCLUDE_NOT_FOUND;
@@ -2094,7 +2087,7 @@
 			if (!IncludeTokenList.empty())
 				{
 				size_t j = IncludeTokenList.size();
-				if (!TokenList.InsertNSlotsAt(j,include_where+1)) throw std::bad_alloc();
+				TokenList.insertNSlotsAt(j,include_where+1);
 				memmove(TokenList.c_array()+include_where+1,IncludeTokenList.data(),j*sizeof(Token&lt;char*&gt;*));
 #ifdef ZAIMONI_NULL_REALLY_IS_ZERO
 				memset(IncludeTokenList.c_array(),0,j*sizeof(Token&lt;char*&gt;*));
@@ -2314,7 +2307,7 @@
 	else{
 		size_t lb = 0;
 		autovalarray_ptr_throws&lt;Token&lt;char&gt;* &gt; TokenListAlt(ub+1);
-		if (!TokenList.InsertNSlotsAt(ub,i+1)) throw std::bad_alloc();
+		TokenList.insertNSlotsAt(ub,i+1);
 		{
 		const Token&lt;char&gt;&amp; tmp = *TokenList[i];
 		while(lb&lt;ub)
@@ -3535,7 +3528,7 @@
 			intradirective_preprocess(Test,0,macros_object,macros_object_expansion,macros_function,macros_function_arglist,macros_function_expansion,&amp;macro_stack);
 			}
 		else{
-			if (!used_macro_stack-&gt;InsertNSlotsAt(1,used_macro_stack-&gt;size())) throw std::bad_alloc();
+			used_macro_stack-&gt;insertNSlotsAt(1,used_macro_stack-&gt;size());
 			used_macro_stack-&gt;back() = _new_buffer_nonNULL_throws&lt;char&gt;(token_len);
 			memmove(used_macro_stack-&gt;back(),x.data()+critical_offset,token_len);
 			intradirective_preprocess(Test,0,macros_object,macros_object_expansion,macros_function,macros_function_arglist,macros_function_expansion,used_macro_stack);
@@ -3635,7 +3628,7 @@
 			dynamic_function_macro_prereplace_once(macros_object, macros_object_expansion, macros_function, macros_function_arglist, macros_function_expansion, &amp;macro_stack, formal_arguments, actual_arguments, Test);
 			}
 		else{
-			if (!used_macro_stack-&gt;InsertNSlotsAt(1,used_macro_stack-&gt;size())) throw std::bad_alloc();
+			used_macro_stack-&gt;insertNSlotsAt(1,used_macro_stack-&gt;size());
 			used_macro_stack-&gt;back() = _new_buffer_nonNULL_throws&lt;char&gt;(token_len);
 			memmove(used_macro_stack-&gt;back(),x.data()+critical_offset,token_len);
 

Modified: trunk/load_src.cpp
===================================================================
--- trunk/load_src.cpp	2010-05-13 05:12:38 UTC (rev 427)
+++ trunk/load_src.cpp	2010-05-14 04:49:26 UTC (rev 428)
@@ -48,6 +48,8 @@
 bool
 load_sourcefile(autovalarray_ptr&lt;Token&lt;char&gt;* &gt;&amp; TokenList, const char* const filename, LangConf&amp; lang)
 {
+	{
+	autovalarray_ptr&lt;Token&lt;char&gt;* &gt; tmpTokenList(1);
 	char* Buffer = NULL;
 #ifndef ZAIMONI_FORCE_ISO
 #	define Buffer_size ArraySize(Buffer)
@@ -70,66 +72,74 @@
 	lang.FlattenComments(Buffer,Buffer_size);
 #endif
 
-	SUCCEED_OR_DIE(TokenList.InsertNSlotsAt(1,0));
+	try {
 #ifndef ZAIMONI_FORCE_ISO
-	TokenList[0] = new Token&lt;char&gt;(Buffer,filename);
+		tmpTokenList[0] = new Token&lt;char&gt;(Buffer,filename);
 #else
-	TokenList[0] = new Token&lt;char&gt;(Buffer,Buffer_size,filename);
-	Buffer_size = 0;
+		tmpTokenList[0] = new Token&lt;char&gt;(Buffer,Buffer_size,filename);
+//		Buffer_size = 0;	// dead code
 #endif
+		}
+	catch(...)
+		{
+		free(Buffer);
+		throw;
+		}
 
 	// next: split on newline, to simplify spotting preprocessing-directives vs file to be preprocessed
-	TokenList[0]-&gt;ltrim(strspn(TokenList[0]-&gt;data(),&quot;\n&quot;));
-	if (TokenList[0]-&gt;empty()) return TokenList.reset(),true;
+	tmpTokenList[0]-&gt;ltrim(strspn(tmpTokenList[0]-&gt;data(),&quot;\n&quot;));
+	if (tmpTokenList[0]-&gt;empty()) return TokenList.reset(),true;
 
 	if (lang.BreakTokenOnNewline)
 		{
-		char* newline_where = strchr(TokenList.back()-&gt;data(),'\n');
+		char* newline_where = strchr(tmpTokenList.back()-&gt;data(),'\n');
 		while(newline_where)
 			{
-			const size_t offset = newline_where-TokenList.back()-&gt;data();
-			if (!TokenList.InsertNSlotsAt(1,TokenList.size()-1)) throw std::bad_alloc();
-			TokenList[TokenList.size()-2] = new Token&lt;char&gt;(*TokenList.back(),offset,0);
-			assert('\n'==TokenList.back()-&gt;data()[0]);
-			if (3&lt;=TokenList.size()) clean_linesplice_whitespace(TokenList,TokenList.size()-3,lang);
-			TokenList.back()-&gt;ltrim(strspn(TokenList.back()-&gt;data(),&quot;\n&quot;));
-			if (TokenList.back()-&gt;empty())
+			const size_t offset = newline_where-tmpTokenList.back()-&gt;data();
+			tmpTokenList.insertNSlotsAt(1,tmpTokenList.size()-1);
+			tmpTokenList[tmpTokenList.size()-2] = new Token&lt;char&gt;(*tmpTokenList.back(),offset,0);
+			assert('\n'==tmpTokenList.back()-&gt;data()[0]);
+			if (3&lt;=tmpTokenList.size()) clean_linesplice_whitespace(tmpTokenList,tmpTokenList.size()-3,lang);
+			tmpTokenList.back()-&gt;ltrim(strspn(tmpTokenList.back()-&gt;data(),&quot;\n&quot;));
+			if (tmpTokenList.back()-&gt;empty())
 				{
-				TokenList.DeleteIdx(TokenList.size()-1);
+				tmpTokenList.DeleteIdx(tmpTokenList.size()-1);
 				break;
 				}
-			newline_where = strchr(TokenList.back()-&gt;data(),'\n');
+			newline_where = strchr(tmpTokenList.back()-&gt;data(),'\n');
 			}
 
 		// final cleanup: works for line-continue languages that consider pure whitespace lines meaningless
-		if (2&lt;=TokenList.size()) clean_linesplice_whitespace(TokenList,TokenList.size()-2,lang);
-		if (!TokenList.empty()) clean_whitespace(TokenList,TokenList.size()-1,lang);
+		if (2&lt;=tmpTokenList.size()) clean_linesplice_whitespace(tmpTokenList,tmpTokenList.size()-2,lang);
+		if (!tmpTokenList.empty()) clean_whitespace(tmpTokenList,tmpTokenList.size()-1,lang);
 		}
 
 	// if the language approves, flush leading whitespace
 	// do not trim trailing whitespace at this time: this breaks error reporting for incomplete C [wide/narrow] character/string literals
 	//! \todo work out how to handle tab stops cleanly
 	{
-	size_t i = TokenList.size();
+	size_t i = tmpTokenList.size();
 	while(0&lt;i)
 		{
-		assert(NULL!=TokenList[i-1]);
-		size_t LeadingWS = strspn(TokenList[--i]-&gt;data(),lang.WhiteSpace+1);
-		TokenList[i]-&gt;ltrim(LeadingWS);
-		assert(!TokenList[i]-&gt;empty());
+		assert(tmpTokenList[i-1]);
+		size_t LeadingWS = strspn(tmpTokenList[--i]-&gt;data(),lang.WhiteSpace+1);
+		tmpTokenList[i]-&gt;ltrim(LeadingWS);
+		assert(!tmpTokenList[i]-&gt;empty());
 		}
 	}
 
 	// correct parent_dir
-	if (!TokenList.empty())
+	if (!tmpTokenList.empty())
 		{
 		char workspace[FILENAME_MAX];
 		z_realpath(workspace,filename);
-		size_t j = TokenList.size();
-		do	TokenList[--j]-&gt;parent_dir = register_string(workspace);
+		size_t j = tmpTokenList.size();
+		do	tmpTokenList[--j]-&gt;parent_dir = register_string(workspace);
 		while(0&lt;j);
 		};
-
+	swap(tmpTokenList,TokenList);
+	}
+	
 #ifndef NDEBUG
 	// post-condition testing
 	{
@@ -146,8 +156,9 @@
 }
 
 //! \throw std::bad_alloc
-bool load_raw_sourcefile(zaimoni::autovalarray_ptr&lt;zaimoni::Token&lt;char&gt;* &gt;&amp; TokenList, const char* const filename)
+bool load_raw_sourcefile(autovalarray_ptr&lt;Token&lt;char&gt;* &gt;&amp; TokenList, const char* const filename)
 {
+	autovalarray_ptr&lt;Token&lt;char&gt;* &gt; tmpTokenList(1);
 	char* Buffer = NULL;
 #ifndef ZAIMONI_FORCE_ISO
 #	define Buffer_size ArraySize(Buffer)
@@ -173,35 +184,35 @@
 #else
 	TrimMandatoryTerminalNewline(Buffer,Buffer_size,filename);
 #endif
-	
-	SUCCEED_OR_DIE(TokenList.InsertNSlotsAt(1,0));
+
+	try	{
 #ifndef ZAIMONI_FORCE_ISO
-	TokenList[0] = new(std::nothrow) Token&lt;char&gt;(Buffer,filename);
+		tmpTokenList[0] = new Token&lt;char&gt;(Buffer,filename);
 #else
-	TokenList[0] = new(std::nothrow) Token&lt;char&gt;(Buffer,Buffer_size,filename);
-	Buffer_size = 0;
+		tmpTokenList[0] = new Token&lt;char&gt;(Buffer,Buffer_size,filename);
+//		Buffer_size = 0;	// dead code
 #endif
-	if (NULL==TokenList[0])
+		}
+	catch(...)
 		{
 		free(Buffer);
-		TokenList.clear();
-		return false;
-		}
+		throw;
+		};
 
-	char* newline_where = strchr(TokenList.back()-&gt;data(),'\n');
+	char* newline_where = strchr(tmpTokenList.back()-&gt;data(),'\n');
 	while(newline_where)
 		{
-		const size_t offset = newline_where-TokenList.back()-&gt;data();
-		if (!TokenList.InsertNSlotsAt(1,TokenList.size()-1)) throw std::bad_alloc();
-		TokenList[TokenList.size()-2] = new Token&lt;char&gt;(*TokenList.back(),offset,0);
-		assert('\n'==TokenList.back()-&gt;data()[0]);
-		TokenList.back()-&gt;ltrim(strspn(TokenList.back()-&gt;data(),&quot;\n&quot;));
-		if (TokenList.back()-&gt;empty())
+		const size_t offset = newline_where-tmpTokenList.back()-&gt;data();
+		tmpTokenList.insertNSlotsAt(1,tmpTokenList.size()-1);
+		tmpTokenList[tmpTokenList.size()-2] = new Token&lt;char&gt;(*tmpTokenList.back(),offset,0);
+		assert('\n'==tmpTokenList.back()-&gt;data()[0]);
+		tmpTokenList.back()-&gt;ltrim(strspn(tmpTokenList.back()-&gt;data(),&quot;\n&quot;));
+		if (tmpTokenList.back()-&gt;empty())
 			{
-			TokenList.DeleteIdx(TokenList.size()-1);
+			tmpTokenList.DeleteIdx(tmpTokenList.size()-1);
 			break;
 			}
-		newline_where = strchr(TokenList.back()-&gt;data(),'\n');
+		newline_where = strchr(tmpTokenList.back()-&gt;data(),'\n');
 		}
-	return true;
+	return swap(tmpTokenList,TokenList),true;
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000194.html">[Zcplusplus-commits] r427 - trunk/Zaimoni.STL
</A></li>
	<LI>Next message: <A HREF="000196.html">[Zcplusplus-commits] r429 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#195">[ date ]</a>
              <a href="thread.html#195">[ thread ]</a>
              <a href="subject.html#195">[ subject ]</a>
              <a href="author.html#195">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/zcplusplus-commits">More information about the Zcplusplus-commits
mailing list</a><br>
</body></html>
